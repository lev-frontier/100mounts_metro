<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase JSON 資料同步</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 600px; margin: auto; }
        .hidden { display: none; }
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type="text"], textarea { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
        .share-box { background: #f4f4f4; padding: 10px; word-break: break-all; border-left: 5px solid #007bff; }
    </style>
</head>
<body>

    <h2>資料儲存與分享系統</h2>

    <div class="card">
        <div id="loginForm">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="btnLogin">登入</button>
        </div>
        <div id="userInfo" class="hidden">
            <span id="userEmail"></span>
            <button id="btnLogout">登出</button>
        </div>
    </div>

    <div class="card">
        <h3>編輯資料</h3>
        <label>姓名 (Name):</label>
        <input type="text" id="fieldName" placeholder="輸入姓名">
        
        <label>
            <input type="checkbox" id="fieldShowLevel"> 顯示等級 (Show Level)
        </label>
        
        <br><br>
        <label>高峰紀錄 (Summits):</label>
        <textarea id="fieldSummits" rows="3" placeholder="例如: 玉山, 雪山..."></textarea>
        
        <button id="btnSave" style="padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer;">儲存到資料庫</button>
    </div>

    <div id="shareArea" class="card hidden">
        <h4>您的專屬分享網址：</h4>
        <div class="share-box" id="shareUrl"></div>
        <p><small>分享此網址給他人，他們即可看到您儲存的資料。</small></p>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.x/firebase-auth.js";
        import { ref, set, get } from "https://www.gstatic.com/firebasejs/10.x/firebase-database.js";

        // --- 1. 初始化讀取 (分享模式) ---
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('id');

            if (sharedId) {
                console.log("正在讀取分享 ID:", sharedId);
                const snapshot = await get(ref(db, `users/${sharedId}`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // 將讀取到的 JSON 填入欄位
                    document.getElementById('fieldName').value = data.name || "";
                    document.getElementById('fieldShowLevel').checked = data.showLevel || false;
                    document.getElementById('fieldSummits').value = data.summits || "";
                }
            }
        });

        // --- 2. 身份狀態變更監聽 ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userEmail').innerText = user.email;
                
                // 產生分享網址
                document.getElementById('shareArea').classList.remove('hidden');
                const link = `${window.location.origin}${window.location.pathname}?id=${user.uid}`;
                document.getElementById('shareUrl').innerText = link;
            } else {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('shareArea').classList.add('hidden');
            }
        });

        // --- 3. 儲存功能 (JSON 格式) ---
        document.getElementById('btnSave').onclick = async () => {
            const user = auth.currentUser;
            if (!user) {
                alert("請先登入才能儲存資料！");
                return;
            }

            // 準備要儲存的 JSON 物件
            const userData = {
                name: document.getElementById('fieldName').value,
                showLevel: document.getElementById('fieldShowLevel').checked,
                summits: document.getElementById('fieldSummits').value,
                updatedAt: Date.now()
            };

            try {
                // 直接將物件存入該使用者的路徑
                await set(ref(db, `users/${user.uid}`), userData);
                alert("資料已成功儲存！");
            } catch (error) {
                console.error(error);
                alert("儲存失敗，請檢查 Firebase 規則。");
            }
        };

        // --- 4. 登入/登出事件 ---
        document.getElementById('btnLogin').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert("登入失敗: " + e.message); }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);

    </script>
</body>
</html>